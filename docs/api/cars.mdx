---
sidebar_position: 4
title: Cars
---

# 4. Cars

## Модель `CarDetection`

Элемент в массиве `cars`:

- **confidence** (`float`, `0.0..1.0`) — достоверность распознавания.
- **points** (`list[4][2]`) — четыре вершины прямоугольника на изображении камеры в формате `[x, y]` (порядок вершин — по часовой; важно, чтобы был замкнутый четырехугольник без самопересечений).

> Проверки на стороне сервера:
> - `0.0 ≤ confidence ≤ 1.0`
> - `points.length == 4`, каждая вершина — массив из двух чисел.
> - Прямоугольник невырожденный (площади ≠ 0).

---

### 4.1 `POST /cars`

Принимает результаты детекции автомобилей с конкретной камеры.

**Headers**
- `Content-Type: application/json`
- `Authorization: Bearer <token>`

**Request body (required)**
- **camera_id** (`integer`) — ID существующей камеры.
- **detection_timestamp** (`string`, ISO 8601) — дата и время кадра, с которого были распознаны автомобили (регистрируется и отправляется `detector`'ом)
- **cars** (`list<CarDetection>`, допускается пустой список) — список всех детекций по камере за данный кадр.

**Response (202)**
```json
{ "status": "accepted" }
```

**Пример запроса**
```http
POST /api/v0/cars HTTP/1.1
Host: parktrack-api.nawinds.dev
Content-Type: application/json
Authorization: Bearer <token>

{
  "camera_id": 1,
  "detection_timestamp": "2025-10-08T09:12:00Z",
  "cars": [
    { "confidence": 0.89, "points": [[23,28],[87,28],[87,42],[23,42]] },
    { "confidence": 0.91, "points": [[28,33],[92,33],[92,47],[28,47]] }
  ]
}
```

**Пример ответа (202)**
```json
{ "status": "accepted" }
```

**Ошибки** (в дополнение к [общим](/docs/api/#общие-ошибки))

| Код     | Тип                    | Описание                                                                                                                                                                                                                                          |
|---------|------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **404** | `Not Found`            | Камера с указанным `camera_id` не существует.                                                                                                                                                                                                     |
| **422** | `Unprocessable Entity` | Валидация не пройдена: `confidence` вне диапазона `0..1`; `points` не 4 вершины; вершины не пары чисел; вырожденный прямоугольник; `detection_timestamp` не в ISO 8601 UTC (с постфиксом `Z`) или слишком сильно расходится с серверным временем. |

**Формат тела ошибки**
```json
{
  "error_description": "Validation error: cars[0].confidence must be between 0 and 1"
}
```

---

### 4.2 `GET /cars` — Long Polling

Long polling для получения **обновлений детекций** по камерам.

За один ответ сервер возвращает данные детекций **только по одной камере**, даже если они доступны по нескольким.
В случае, когда данные есть по нескольким камерам, возвращаются данные по камере с самым ранним временем детекции.

**Headers**
- `Authorization: Bearer <token>`

**Query-параметры**
- **since** (`string`, ISO 8601, опц.) — вернуть события новее указанного времени.
- **timeout** (`integer`, сек., опц., ≤60, по умолчанию 30) — сколько секунд держать соединение открытым, если новых данных нет.
- **limit** (`integer`, опц.) — максимальное число событий/пакетов в ответе.

**Поведение long polling**
- Если **есть новые данные** — сервер сразу возвращает их с `200`.
- Если **нет новых данных** — сервер держит соединение до `timeout` секунд, затем возвращает `204 No Content`.
Если за `timeout` секунд ожидания данные появились, сервер также возвращает их с `200`.

> На одну камеру должно быть не более 1 одновременного long polling запроса.

**Response (200)** — пакет обновлений
```json
{
  "camera_id": 1,
  "since": "2025-10-08T09:12:00Z",
  "next_since": "2025-10-08T09:12:30Z",
  "cars": [
    { "confidence": 0.89, "points": [[23,28],[87,28],[87,42],[23,42]] },
    { "confidence": 0.91, "points": [[28,33],[92,33],[92,47],[28,47]] }
  ]
}
```

**Response (204)** — при отсутствии новых данных (вариант поведения).

**Пример запроса (с курсором времени)**
```http
GET /api/v0/cars?since=2025-10-08T09:12:00Z&timeout=25 HTTP/1.1
Host: parktrack-api.nawinds.dev
Authorization: Bearer <token>
```

**Пример ответа (200)**
```json
{
  "camera_id": 1,
  "since": "2025-10-08T09:12:00Z",
  "next_since": "2025-10-08T09:12:30Z",
  "cars": [
    { "confidence": 0.89, "points": [[23,28],[87,28],[87,42],[23,42]] },
    { "confidence": 0.91, "points": [[28,33],[92,33],[92,47],[28,47]] }
  ]
}
```

**Ошибки** (в дополнение к [общим](/docs/api/#общие-ошибки))

| Код     | Тип                      | Описание                                                                                                  |
|---------|--------------------------|-----------------------------------------------------------------------------------------------------------|
| **404** | `Not Found`              | Камера с указанным `camera_id` не существует.                                                              |
| **408** | `Request Timeout`        | Клиент оборвал соединение/истёк таймаут на стороне прокси.                                                |
| **422** | `Unprocessable Entity`   | Невалидный `since` (не ISO 8601) или конфликт параметров (`since` и `last_event_id` одновременно и это запрещено политикой). |

**Рекомендации клиенту**
- Повторять запрос с `since`=`next_since`, полученным в ответе.
- При `204` — повторить через короткую задержку (джиттер 200–500 мс).
- Ограничить параллельные long-poll соединения на камеру одним.

---
